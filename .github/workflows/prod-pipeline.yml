name: Prod Pipeline (release)

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - 'release/**'

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  prod-release:
    runs-on: ubuntu-latest
    env:
      REPO: pencraft
      REGION: ${{ secrets.GCP_REGION }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      BUCKET: ${{ secrets.GCP_PROJECT_ID }}-builds
      GITOPS_REPO: ${{ secrets.GITOPS_REPO }}

    steps:
      - name: Checkout repository (full history for tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Compute RELEASE_TAG
        id: tag
        run: |
          set -euxo pipefail
          REF_NAME="${GITHUB_REF_NAME:-}"
          REF_TYPE="${GITHUB_REF_TYPE:-}"
          if [ -z "$REF_NAME" ]; then
            case "${GITHUB_REF}" in
              refs/tags/*) REF_NAME="${GITHUB_REF#refs/tags/}"; REF_TYPE="tag" ;;
              refs/heads/*) REF_NAME="${GITHUB_REF#refs/heads/}"; REF_TYPE="branch" ;;
              *) REF_NAME="${GITHUB_REF}"; REF_TYPE="other" ;;
            esac
          fi
          if [[ "$REF_TYPE" == "branch" && "$REF_NAME" == release/* ]]; then
            RELEASE=${REF_NAME//\//-}
          else
            RELEASE="$REF_NAME"
          fi
          echo "RELEASE_TAG=$RELEASE" >> "$GITHUB_OUTPUT"

      - name: Authenticate to Google Cloud
        id: gcp-auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev -q

      - name: Ensure GCS bucket exists
        run: |
          gsutil ls gs://$BUCKET || gsutil mb -l $REGION gs://$BUCKET

      - name: Cache Maven local repo
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: maven-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Build backend (Spring Boot)
        working-directory: java-store
        run: mvn -B -DskipTests package

      - name: Upload backend artifact
        run: gsutil cp java-store/target/*.jar gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/backend/ || true

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: node-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: node-

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run build

      - name: Upload frontend artifact
        run: gsutil cp -r frontend/build gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/frontend/ || true

      - name: Build and tag images
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE} ./java-store
          docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:latest
          docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE} ./frontend
          docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE} ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:latest

      # ========= FIXED TRIVY STEP ==========
      - name: Run Trivy scan (fail on HIGH/CRITICAL)
        uses: aquasecurity/trivy-action@v0.33.1
        with:
          image-ref: |
            ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${{ steps.tag.outputs.RELEASE_TAG }}
            ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${{ steps.tag.outputs.RELEASE_TAG }}
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '1'
      # =====================================

      - name: Push images to GAR
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:latest
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:latest

      - name: Update GitOps repo (update existing release branch)
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
          GITOPS_PAT: ${{ secrets.GITOPS_PAT }}
        run: |
          set -euxo pipefail
          git clone https://x-access-token:${GITOPS_PAT}@github.com/${{ secrets.GITOPS_REPO }}.git gitops
          cd gitops
          git config user.email "mspr9773@gmail.com"
          git config user.name "Mokadi Surya Prasad"

          BRANCH="release/${RELEASE}"
          git fetch origin ${BRANCH}
          git checkout ${BRANCH}
          git pull origin ${BRANCH}

          export NEW_BACKEND="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}"
          export NEW_FRONTEND="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}"

          if ! command -v yq >/dev/null; then
            wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            chmod +x /usr/local/bin/yq
          fi

          yq eval -i '.backend.image = strenv(NEW_BACKEND)' envs/prod/values-prod.yaml
          yq eval -i '.frontend.image = strenv(NEW_FRONTEND)' envs/prod/values-prod.yaml

          git add envs/prod/values-prod.yaml
          git commit -m "update prod images to ${RELEASE}" || echo "no changes"
          git push origin ${BRANCH}
