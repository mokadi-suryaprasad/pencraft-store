name: Prod Pipeline (release)

on:
  push:
    tags:
      - 'v*.*.*'
    branches:
      - 'release/**'
  workflow_dispatch: {}

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  prod-release:
    runs-on: ubuntu-latest
    env:
      REPO: pencraft
      REGION: ${{ secrets.GCP_REGION }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      BUCKET: ${{ secrets.GCP_PROJECT_ID }}-builds
      GITOPS_REPO: mokadi-suryaprasad/pencraft-gitops

    steps:

      # ------------------------------
      # Checkout
      # ------------------------------
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ------------------------------
      # Compute release tag
      # ------------------------------
      - name: Compute RELEASE_TAG
        id: tag
        run: |
          set -euxo pipefail
          REF_NAME="${GITHUB_REF_NAME:-}"
          REF_TYPE="${GITHUB_REF_TYPE:-}"

          if [ -z "$REF_NAME" ]; then
            case "${GITHUB_REF}" in
              refs/tags/*) REF_NAME="${GITHUB_REF#refs/tags/}"; REF_TYPE="tag" ;;
              refs/heads/*) REF_NAME="${GITHUB_REF#refs/heads/}"; REF_TYPE="branch" ;;
            esac
          fi

          if [[ "$REF_TYPE" == "branch" && "$REF_NAME" == release/* ]]; then
            RELEASE="${REF_NAME//\//-}"
          else
            RELEASE="$REF_NAME"
          fi

          echo "RELEASE_TAG=$RELEASE" >> "$GITHUB_OUTPUT"

      # ------------------------------
      # GCP Authentication
      # ------------------------------
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          export_default_credentials: true
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev -q

      - name: Ensure GCS bucket exists
        run: |
          gsutil ls gs://$BUCKET || gsutil mb -l $REGION gs://$BUCKET

      # ------------------------------
      # Build Backend
      # ------------------------------
      - name: Build backend
        working-directory: java-store
        run: mvn -B -DskipTests package

      - name: Upload backend artifact
        run: gsutil cp java-store/target/*.jar gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/backend/ || true

      # ------------------------------
      # Build Frontend (updated: npm install)
      # ------------------------------
      - name: Build frontend
        working-directory: frontend
        run: |
          npm install
          npm run build

      - name: Upload frontend artifact
        run: gsutil cp -r frontend/build gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/frontend/ || true

      # ------------------------------
      # Docker Image Build
      # ------------------------------
      - name: Build images
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE} ./java-store
          docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE} \
                     ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:latest

          docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE} ./frontend
          docker tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE} \
                     ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:latest

      # ------------------------------
      # Install Trivy & Scan (working)
      # ------------------------------
      - name: Install Trivy CLI
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
            | sh -s -- -b /usr/local/bin
          trivy --version

      - name: Trivy Image Scan (fail on HIGH+CRITICAL)
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          set -euxo pipefail

          IMG1="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}"
          IMG2="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}"

          trivy image --format table --severity CRITICAL --exit-code 1 "$IMG1"
          trivy image --format table --severity CRITICAL --exit-code 1 "$IMG2"

      # ------------------------------
      # Push to GAR
      # ------------------------------
      - name: Push images
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:latest

          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}
          docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:latest

      # ------------------------------
      # Update GitOps Repo (existing release branch)
      # ------------------------------
      - name: Update GitOps repo (yq)
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
          GITOPS_PAT: ${{ secrets.GITOPS_PAT }}
        run: |
          set -euxo pipefail

          git clone https://x-access-token:${GITOPS_PAT}@github.com/${GITOPS_REPO}.git gitops
          cd gitops

          git config user.email "mspr9773@gmail.com"
          git config user.name "Mokadi Surya Prasad"

          BRANCH="release/${RELEASE}"

          # Ensure branch exists
          if ! git ls-remote --heads origin "${BRANCH}" | grep -q "${BRANCH}"; then
            echo "ERROR: Branch ${BRANCH} not found in GitOps repo"
            exit 1
          fi

          git fetch origin ${BRANCH}
          git checkout ${BRANCH}
          git pull origin ${BRANCH}

          export NEW_BACKEND="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/java-store:${RELEASE}"
          export NEW_FRONTEND="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/frontend:${RELEASE}"

          # Install yq if missing
          if ! command -v yq >/dev/null; then
            wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            chmod +x /usr/local/bin/yq
          fi

          # Update YAML
          yq eval -i '.backend.image = strenv(NEW_BACKEND)' envs/prod/values-prod.yaml
          yq eval -i '.frontend.image = strenv(NEW_FRONTEND)' envs/prod/values-prod.yaml

          git add envs/prod/values-prod.yaml

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "chore(release): update prod images to ${RELEASE}"
          git push origin ${BRANCH}
