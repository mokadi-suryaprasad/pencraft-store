name: Prod Pipeline (release)

on:
  push:
    tags:
      - 'v*.*.*'         # release tags like v1.2.3
    branches:
      - 'release/**'     # or pushing to release/* branches (optional)

permissions:
  contents: read
  packages: write
  id-token: write

jobs:
  prod-release:
    runs-on: ubuntu-latest
    env:
      REPO: pencraft
      REGION: ${{ secrets.GCP_REGION }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      BUCKET: ${{ secrets.GCP_PROJECT_ID }}-builds
      GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
      # RELEASE_TAG will be computed in the workflow

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Ensure GCS bucket exists
        run: |
          gsutil ls gs://$BUCKET || gsutil mb -l $REGION gs://$BUCKET

      - name: Compute RELEASE_TAG
        id: tag
        run: |
          # If triggered by tag, GITHUB_REF is like refs/tags/v1.2.3
          # If triggered by branch (release/*) set RELEASE_TAG from branch name
          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            RELEASE=${GITHUB_REF#refs/tags/}
          else
            # When pushing to release/branch, use branch name (strip refs/heads/)
            RELEASE=${GITHUB_REF#refs/heads/}
            # sanitize slashes for tag usage
            RELEASE=${RELEASE//\//-}
          fi
          echo "RELEASE_TAG=$RELEASE" >> $GITHUB_OUTPUT

      - name: Build backend (Spring Boot)
        working-directory: java-store
        run: mvn -B -DskipTests package

      - name: Upload backend artifact (optional)
        run: |
          gsutil cp java-store/target/*.jar gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/backend/ || true

      - name: Build frontend (React)
        working-directory: frontend
        run: |
          # use npm install to avoid failing when package-lock.json is missing
          npm install
          npm run build

      - name: Upload frontend artifact (optional)
        run: |
          gsutil cp -r frontend/build gs://$BUCKET/${{ steps.tag.outputs.RELEASE_TAG }}/frontend/ || true

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker $REGION-docker.pkg.dev -q

      - name: Build and tag images (release)
        run: |
          RELEASE=${{ steps.tag.outputs.RELEASE_TAG }}
          echo "Building images for release: $RELEASE"
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$RELEASE ./java-store
          docker tag  $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$RELEASE \
                      $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:latest
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$RELEASE ./frontend
          docker tag  $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$RELEASE \
                      $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:latest

      - name: Install Trivy (reliable manual install)
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
           | sh -s -- -b /usr/local/bin

      - name: Trivy scan backend (high/critical only)
        run: |
          RELEASE=${{ steps.tag.outputs.RELEASE_TAG }}
          trivy image --exit-code 0 --severity HIGH,CRITICAL \
            $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$RELEASE

      - name: Trivy scan frontend (high/critical only)
        run: |
          RELEASE=${{ steps.tag.outputs.RELEASE_TAG }}
          trivy image --exit-code 0 --severity HIGH,CRITICAL \
            $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$RELEASE

      - name: Push images to GAR
        run: |
          RELEASE=${{ steps.tag.outputs.RELEASE_TAG }}
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$RELEASE
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:latest
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$RELEASE
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:latest

      - name: Update GitOps repo (create release branch)
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          git clone https://github.com/${GITOPS_REPO}.git gitops
          cd gitops

          # fix identity for commits
          git config --global user.email "mspr9773@gmail.com"
          git config --global user.name "Mokadi Surya Prasad"

          BRANCH="release/${RELEASE}"
          git checkout -b "$BRANCH"

          # Update prod values - adjust sed to match your YAML structure if needed
          sed -i "s|java-store:.*|java-store: $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:${RELEASE}|g" envs/prod/values-prod.yaml
          sed -i "s|frontend:.*|frontend: $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:${RELEASE}|g" envs/prod/values-prod.yaml

          git add envs/prod/values-prod.yaml
          git commit -m "chore(release): update prod images to ${RELEASE}"
          git push https://x-access-token:${{ secrets.GITOPS_PAT }}@github.com/${GITOPS_REPO}.git HEAD

      - name: Create PR for production release
        env:
          RELEASE: ${{ steps.tag.outputs.RELEASE_TAG }}
        run: |
          BRANCH="release/${RELEASE}"
          curl -s -X POST -H "Authorization: token ${{ secrets.GITOPS_PAT }}" \
            -d "{\"title\":\"Release ${RELEASE}: update prod images\",\"head\":\"${BRANCH}\",\"base\":\"main\",\"body\":\"Release ${RELEASE} - update Helm images\"}" \
            https://api.github.com/repos/${GITOPS_REPO}/pulls
