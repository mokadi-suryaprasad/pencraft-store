name: Dev Pipeline (main â†’ Dev)

on:
  push:
    branches: [ "main" ]
    paths:
      - "java-store/**"
      - "frontend/**"
      - ".github/workflows/dev-pipeline.yml"

env:
  REPO: pencraft
  GITOPS_REPO: ${{ secrets.GITOPS_REPO }}    # YOUR-USERNAME/pencraft-gitops
  GITOPS_BRANCH_PREFIX: "auto/update/dev"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Authenticate GCP
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          service_account_key: ${{ secrets.GCP_SA_KEY }}

      # Upload build artifacts to GCS (optional)
      - name: Build backend JAR
        working-directory: java-store
        run: mvn -B -DskipTests package

      - name: Upload backend artifact to GCS
        run: |
          gsutil cp java-store/target/*.jar gs://YOUR_BUCKET_NAME/builds/${{ github.sha }}/

      - name: Build frontend production
        working-directory: frontend
        run: |
          npm ci
          npm run build
      - name: Upload frontend build to GCS
        run: |
          gsutil cp -r frontend/build gs://YOUR_BUCKET_NAME/builds/${{ github.sha }}/frontend/

      # Authenticate Docker to GAR
      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ secrets.GCP_REGION }}-docker.pkg.dev -q

      # Build images and tag with git-sha + latest
      - name: Build & tag backend image
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          docker build -t ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/java-store:${GIT_SHA} ./java-store
          docker tag ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/java-store:${GIT_SHA} ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/java-store:latest

      - name: Build & tag frontend image
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          docker build -t ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/frontend:${GIT_SHA} ./frontend
          docker tag ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/frontend:${GIT_SHA} ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/frontend:latest

      # Trivy scan
      - name: Trivy scan backend image
        uses: aquasecurity/trivy-action@v0.12.0
        with:
          image-ref: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/java-store:${{ github.sha }}
          format: 'table'

      - name: Trivy scan frontend image
        uses: aquasecurity/trivy-action@v0.12.0
        with:
          image-ref: ${{ secrets.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/frontend:${{ github.sha }}
          format: 'table'

      # Push images
      - name: Push backend image to GAR
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          docker push ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/java-store:${GIT_SHA}
          docker push ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/java-store:latest

      - name: Push frontend image to GAR
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          docker push ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/frontend:${GIT_SHA}
          docker push ${GCP_REGION?-set env}/asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPO }}/frontend:latest

      # Update GitOps repo values-dev.yaml and create PR
      - name: Clone GitOps repo
        env:
          GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          git clone https://github.com/${GITOPS_REPO}.git gitops
          cd gitops
          git checkout -b ${{ env.GITOPS_BRANCH_PREFIX }}-${GIT_SHA}
          # Update values-dev.yaml paths (adjust sed for YAML structure)
          sed -i "s|frontend:.*|frontend:\n  image: \"asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/pencraft/frontend:${GIT_SHA}\"|g" envs/dev/values-dev.yaml
          sed -i "s|backend:.*|backend:\n  image: \"asia-south1-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/pencraft/java-store:${GIT_SHA}\"|g" envs/dev/values-dev.yaml
          git add envs/dev/values-dev.yaml
          git commit -m "chore: update dev images to ${GIT_SHA}"
          # push with PAT
          git push https://x-access-token:${{ secrets.GITOPS_PAT }}@github.com/${GITOPS_REPO}.git HEAD

      - name: Create PR to GitOps repo
        env:
          GITOPS_REPO: ${{ secrets.GITOPS_REPO }}
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          curl -s -X POST -H "Authorization: token ${{ secrets.GITOPS_PAT }}" \
            -d "{\"title\":\"chore: update dev images to ${GIT_SHA}\",\"head\":\"${{ env.GITOPS_BRANCH_PREFIX }}-${GIT_SHA}\",\"base\":\"main\",\"body\":\"Auto update images for dev: ${GIT_SHA}\"}" \
            https://api.github.com/repos/${GITOPS_REPO}/pulls

