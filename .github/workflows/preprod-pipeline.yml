name: PreProd Pipeline (Pre-Prod Deploy via GitOps)

on:
  push:
    branches:
      - preprod
    paths:
      - "java-store/**"
      - "frontend/**"
      - ".github/workflows/preprod-pipeline.yml"

  pull_request:
    types: [closed]            # runs ONLY when PR closes
    branches:
      - preprod                # PR must target preprod

jobs:
  preprod-build:
    # Run only when push happens OR PR was merged
    if: github.event_name == 'push' || github.event.pull_request.merged == true

    runs-on: ubuntu-latest

    env:
      REGION: ${{ secrets.GCP_REGION }}
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      BUCKET: ${{ secrets.GCP_PROJECT_ID }}-builds
      GIT_SHA: ${{ github.sha }}
      REPO: pencraft
      GITOPS_REPO: mokadi-suryaprasad/pencraft-gitops

    steps:
      # 1) Checkout
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Authenticate to GCP
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 3) Ensure bucket exists
      - name: Ensure GCS bucket exists
        run: |
          gsutil ls gs://$BUCKET || gsutil mb -l $REGION gs://$BUCKET

      # 4) Build backend
      - name: Build Spring Boot backend
        working-directory: java-store
        run: mvn -B -DskipTests package

      - name: Upload backend JAR to GCS
        run: |
          gsutil cp java-store/target/*.jar gs://$BUCKET/$GIT_SHA/backend/

      # 5) Build frontend
      - name: Build React frontend
        working-directory: frontend
        run: |
          npm install
          npm run build

      - name: Upload frontend build to GCS
        run: |
          gsutil cp -r frontend/build gs://$BUCKET/$GIT_SHA/frontend/

      # 6) Configure Docker for GAR
      - name: Configure Docker for Google Artifact Registry
        run: gcloud auth configure-docker $REGION-docker.pkg.dev -q

      # 7) Build images
      - name: Build & tag backend image
        run: |
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$GIT_SHA ./java-store
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$GIT_SHA

      - name: Build & tag frontend image
        run: |
          docker build -t $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$GIT_SHA ./frontend
          docker push $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$GIT_SHA

      # 8) Install Trivy
      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh \
          | sh -s -- -b /usr/local/bin

      # 9) Trivy Scans
      - name: Scan backend image with Trivy
        run: |
          trivy image --exit-code 0 --severity HIGH,CRITICAL \
          $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$GIT_SHA

      - name: Scan frontend image with Trivy
        run: |
          trivy image --exit-code 0 --severity HIGH,CRITICAL \
          $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$GIT_SHA

      # 10) Update GitOps repo
      - name: Update GitOps Repo
        run: |
          git clone https://github.com/$GITOPS_REPO.git gitops
          cd gitops

          git config --global user.email "mspr9773@gmail.com"
          git config --global user.name "Mokadi Surya Prasad"

          git checkout -b auto-update-preprod-$GIT_SHA

          sed -i "s|java-store:.*|java-store: $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/java-store:$GIT_SHA|g" envs/preprod/values-preprod.yaml
          sed -i "s|frontend:.*|frontend: $REGION-docker.pkg.dev/$PROJECT_ID/$REPO/frontend:$GIT_SHA|g" envs/preprod/values-preprod.yaml

          git add envs/preprod/values-preprod.yaml
          git commit -m "Update PreProd images to $GIT_SHA"
          git push https://x-access-token:${{ secrets.GITOPS_PAT }}@github.com/$GITOPS_REPO.git HEAD

      # 11) Create PR
      - name: Create PR to GitOps repo
        run: |
          curl -s -X POST -H "Authorization: token ${{ secrets.GITOPS_PAT }}" \
          -d "{\"title\":\"PreProd Update: $GIT_SHA\", \
               \"head\":\"auto-update-preprod-$GIT_SHA\", \
               \"base\":\"main\"}" \
          https://api.github.com/repos/$GITOPS_REPO/pulls
